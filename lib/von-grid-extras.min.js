vg.GeneratedTileManager=function(e){this.board=e,this.geoGen=null,this.overlay=null},vg.GeneratedTileManager.prototype={makeTiles:function(e,t){this.board.reset(),this.makeGenerator();var i,s,h,o;if(h=this.geoGen.makeTileGeo({height:e||50}),!t)for(t=[],i=0;10>i;i++)t.push(new THREE.MeshPhongMaterial({color:vg.util.randomizeRGB("30, 30, 30",13)}));for(i in this.board.grid.cells)s=this.board.grid.cells[i],o=new vg.Tile({cell:s,geometry:h,material:t[s.materialId],scale:1}),o.position.copy(this.board.grid.cellToPixel(s)),o.position.y=s.h*this.board.tileHeightStep,this.board.tiles.push(o),this.board.tileGroup.add(o.mesh)},makeGenerator:function(){if(!this.geoGen||this.geoGen.type!==this.board.grid.type)switch(this.board.grid.type){case vg.HEX:this.geoGen=new vg.HexGeoGenerator;break;case vg.SQR:this.geoGen=new vg.SqrGeoGenerator;break;default:throw new Error("[GeneratedTileManager] Only hex and square grids are supported")}this.geoGen.init(this.board.grid)},makeOverlay:function(e,t){t=t||0;var i=new THREE.LineBasicMaterial({color:t,opacity:.3});this.makeGenerator(),this.overlay&&this.board.group.remove(this.overlay),this.overlay=new THREE.Object3D,this.geoGen.makeOverlay(this.overlay,e,i),this.board.group.add(this.overlay)}},vg.HexGeoGenerator=function(){this.tileGeo=null,this.tileShape=null,this.flatGeo=null,this.shapeGeo=null,this.vertices=null,this.grid=null,this.type=vg.HEX,this._cel=new vg.Cell,this._vec3=new THREE.Vector3,this._tileSize=-1,this._cellWidth=0,this._cellLength=0},vg.HexGeoGenerator.prototype={init:function(e){this.grid=e;var t=this.grid.cellSize;this.flatGeo&&this.flatGeo.dispose(),this.shapeGeo&&this.shapeGeo.dispose(),this._tileSize=t||10,this._cellWidth=2*this._tileSize,this._cellLength=.5*vg.SQRT3*this._cellWidth;var i,s,h,o=[];for(i=0;6>i;i++)s=vg.TAU/6*i,h=new THREE.Vector3(this._tileSize*Math.cos(s),0,this._tileSize*Math.sin(s)),o.push(h);for(this.vertices=o,this.tileShape=new THREE.Shape,this.tileShape.moveTo(o[0].x,o[0].z),i=1;6>i;i++)this.tileShape.lineTo(o[i].x,o[i].z);this.tileShape.lineTo(o[0].x,o[0].z),this.tileShape.autoClose=!0,this.shapeGeo=new THREE.ShapeGeometry(this.tileShape),this.shapeGeo.rotateX(90*vg.DEG_TO_RAD),this.shapeGeo.verticesNeedUpdate=!0,this.flatGeo=new THREE.Geometry,this.flatGeo.vertices=o,this.flatGeo.verticesNeedUpdate=!0},makeTileGeo:function(e){e=e||{};var t={amount:1,bevelEnabled:!1,bevelSegments:1,steps:1,bevelSize:.5,bevelThickness:.5};return vg.util.overwrite(t,e),t.amount=e.height||t.amount,this.tileGeo&&this.tileGeo.dispose(),this.tileGeo=new THREE.ExtrudeGeometry(this.tileShape,t),this.tileGeo},makeTilePoly:function(e){e||(e=new THREE.MeshBasicMaterial({color:2405631}));var t=new THREE.Mesh(this.shapeGeo,e);return t},makeTileHighlight:function(e){e||(e=new THREE.MeshBasicMaterial({color:2405631}));var t=new THREE.TorusGeometry(this.grid.cellSize,2,3,6),i=new THREE.Mesh(t,e);return i.rotateX(vg.PI/2),i.scale.x=.8,i.scale.y=.8,i},makeOverlay:function(e,t,i){var s,h,o,l=this.tileShape.createPointsGeometry();for(s=-t;t+1>s;s++)for(h=-t;t+1>h;h++)if(o=-s-h,Math.abs(s)<=t&&Math.abs(h)<=t&&Math.abs(o)<=t){this._cel.set(s,h,o);var a=new THREE.Line(l,i);a.position.copy(this._cellToPixel(this._cel)),a.position.y=0,a.rotation.x=90*vg.DEG_TO_RAD,e.add(a)}},dispose:function(){this.tileGeo&&this.tileGeo.dispose(),this.flatGeo&&this.flatGeo.dispose(),this.shapeGeo&&this.shapeGeo.dispose()},_cellToPixel:function(e){return this._vec3.x=e.q*this._cellWidth*.75,this._vec3.y=e.h,this._vec3.z=-((e.s-e.r)*this._cellLength*.5),this._vec3}},vg.Scene=function(e,t){var i={element:document.body,alpha:!0,antialias:!0,clearColor:"#fff",sortObjects:!1,fog:null,light:null,lightPosition:null,cameraType:"PerspectiveCamera",cameraPosition:null,orthoZoom:4},s={minDistance:100,maxDistance:1e3,zoomSpeed:2,noZoom:!1};if(i=vg.util.merge(i,e),"boolean"!=typeof t&&(s=vg.util.merge(s,t)),this.renderer=new THREE.WebGLRenderer({alpha:i.alpha,antialias:i.antialias}),this.renderer.setClearColor(i.clearColor,0),this.renderer.sortObjects=i.sortObjects,this.width=window.innerWidth,this.height=window.innerHeight,this.orthoZoom=i.orthoZoom,this.container=new THREE.Scene,this.container.fog=i.fog,i.light||(i.light=new THREE.DirectionalLight(14540253),this.container.add(new THREE.AmbientLight(14540253))),i.lightPosition||i.light.position.set(-1,1,-1).normalize(),this.container.add(i.light),this.light=i.light,"OrthographicCamera"===i.cameraType){var h=window.innerWidth/this.orthoZoom,o=window.innerHeight/this.orthoZoom;this.camera=new THREE.OrthographicCamera(h/-2,h/2,o/2,o/-2,1,5e3)}else this.camera=new THREE.PerspectiveCamera(50,this.width/this.height,1,5e3);this.contolled=!!t,this.contolled&&(this.controls=new THREE.OrbitControls(this.camera,this.renderer.domElement),vg.util.overwrite(this.controls,s)),i.cameraPosition&&this.camera.position.copy(i.cameraPosition),window.addEventListener("resize",function(){if(this.width=window.innerWidth,this.height=window.innerHeight,"OrthographicCamera"===this.camera.type){var e=this.width/this.orthoZoom,t=this.height/this.orthoZoom;this.camera.left=e/-2,this.camera.right=e/2,this.camera.top=t/2,this.camera.bottom=t/-2}else this.camera.aspect=this.width/this.height;this.camera.updateProjectionMatrix(),this.renderer.setSize(this.width,this.height)}.bind(this),!1),this.attachTo(i.element)},vg.Scene.prototype={constructor:vg.Scene,attachTo:function(e){e.style.width=this.width+"px",e.style.height=this.height+"px",this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.setSize(this.width,this.height),e.appendChild(this.renderer.domElement)},add:function(e){this.container.add(e)},remove:function(e){this.container.remove(e)},render:function(){this.contolled&&this.controls.update(),this.renderer.render(this.container,this.camera)},enableShadows:function(){this.light.castShadow=!0,this.light.shadow.bias=1e-4,this.light.shadow.mapSize.width=2048,this.light.shadow.mapSize.height=2048,this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=THREE.PCFShadowMap},updateOrthoZoom:function(){if(this.orthoZoom<=0)return void(this.orthoZoom=0);var e=this.width/this.orthoZoom,t=this.height/this.orthoZoom;this.camera.left=e/-2,this.camera.right=e/2,this.camera.top=t/2,this.camera.bottom=t/-2,this.camera.updateProjectionMatrix()},focusOn:function(e){this.camera.lookAt(e.position)}},vg.SelectionManager=function(e){this.mouse=e,this.onSelect=new vg.Signal,this.onDeselect=new vg.Signal,this.selected=null,this.toggleSelection=!1,this.mouse.signal.add(this.onMouse,this)},vg.SelectionManager.prototype={select:function(e,t){e&&(t=t||!0,this.selected!==e&&this.clearSelection(t),e.selected?this.toggleSelection&&(t&&this.onDeselect.dispatch(e),e.deselect()):e.select(),this.selected=e,t&&this.onSelect.dispatch(e))},clearSelection:function(e){e=e||!0,this.selected&&(e&&this.onDeselect.dispatch(this.selected),this.selected.deselect()),this.selected=null},onMouse:function(e,t){switch(e){case vg.MouseCaster.DOWN:t||this.clearSelection();break;case vg.MouseCaster.CLICK:this.select(t)}}},vg.SelectionManager.prototype.constructor=vg.SelectionManager,vg.SqrGeoGenerator=function(){this.tileGeo=null,this.tileShape=null,this.flatGeo=null,this.shapeGeo=null,this.vertices=null,this.grid=null,this.type=vg.SQR,this._cel=new vg.Cell,this._vec3=new THREE.Vector3,this._tileSize=-1,this._cellWidth=0,this._cellLength=0},vg.SqrGeoGenerator.prototype={init:function(e){this.grid=e;var t=this.grid.cellSize;this.flatGeo&&this.flatGeo.dispose(),this.shapeGeo&&this.shapeGeo.dispose(),this._tileSize=t||10,this._cellWidth=2*this._tileSize,this._cellLength=this._cellWidth;var i,s=[];for(s.push(new THREE.Vector3(0,0,0)),s.push(new THREE.Vector3(this._tileSize,0,0)),s.push(new THREE.Vector3(this._tileSize,0,this._tileSize)),s.push(new THREE.Vector3(0,0,this._tileSize)),this.vertices=s,this.tileShape=new THREE.Shape,this.tileShape.moveTo(s[0].x,s[0].z),i=1;4>i;i++)this.tileShape.lineTo(s[i].x,s[i].z);this.tileShape.lineTo(s[0].x,s[0].z),this.tileShape.autoClose=!0,this.shapeGeo=new THREE.ShapeGeometry(this.tileShape),this.shapeGeo.rotateX(90*vg.DEG_TO_RAD),this.shapeGeo.verticesNeedUpdate=!0,this.flatGeo=new THREE.Geometry,this.flatGeo.vertices=s,this.flatGeo.rotateX(90*vg.DEG_TO_RAD),this.flatGeo.verticesNeedUpdate=!0},makeTileGeo:function(e){e=e||{};var t={amount:1,bevelEnabled:!1,bevelSegments:1,steps:1,bevelSize:.5,bevelThickness:.5};return vg.util.overwrite(t,e),t.amount=e.height||t.amount,this.tileGeo&&this.tileGeo.dispose(),this.tileGeo=new THREE.ExtrudeGeometry(this.tileShape,t),this.tileGeo},makeTilePoly:function(e){e||(e=new THREE.MeshBasicMaterial({color:2405631}));var t=new THREE.Mesh(this.shapeGeo,e);return t},makeTileHighlight:function(e){e||(e=new THREE.MeshBasicMaterial({color:2405631}));var t=new THREE.TorusGeometry(this.grid.cellSize,2,3,4),i=new THREE.Mesh(t,e);return i.scale.x=.8,i.scale.y=.8,i},makeOverlay:function(e,t,i){var s,h,o,l=this.tileShape.createPointsGeometry();for(s=-t;t+1>s;s++)for(h=-t;t+1>h;h++)if(o=-s-h,Math.abs(s)<=t&&Math.abs(h)<=t&&Math.abs(o)<=t){this._cel.set(s,h,o);var a=new THREE.Line(l,i);a.position.copy(this._cellToPixel(this._cel)),a.position.y=0,a.rotation.x=90*vg.DEG_TO_RAD,e.add(a)}},dispose:function(){this.tileGeo&&this.tileGeo.dispose(),this.flatGeo&&this.flatGeo.dispose(),this.shapeGeo&&this.shapeGeo.dispose()},_cellToPixel:function(e){return this._vec3.x=e.q*this._fullCellSize,this._vec3.y=e.h,this._vec3.z=e.r*this._fullCellSize,this._vec3}},vg.Tile=function(e){e=e||{};var t={scale:1,cell:null,geometry:null,material:null,rotate:!0};if(t=vg.util.merge(t,e),!t.cell||!t.geometry)throw new Error("Missing vg.Tile configuration");t.cell.tile&&t.cell.tile.dispose(),this.cell=t.cell,this.cell.tile=this,this.uniqueID=vg.util.generateID(),this.geometry=t.geometry,this.material=t.material,this.material||(this.material=new THREE.MeshPhongMaterial({color:vg.util.randomizeRGB("30, 30, 30",13)})),this.objectType=vg.TILE,this.entity=null,this.userData={},this.selected=!1,this.highlight="0x0084cc",this.mesh=new THREE.Mesh(this.geometry,this.material),this.mesh.userData.structure=this,this.position=this.mesh.position,this.rotation=this.mesh.rotation,t.rotate&&(this.rotation.x=90*vg.DEG_TO_RAD),this.mesh.scale.set(t.scale,t.scale,1),this.material.emissive?this._emissive=this.material.emissive.getHex():this._emissive=null},vg.Tile.prototype={select:function(){return this.material.emissive&&this.material.emissive.setHex(this.highlight),this.selected=!0,this},deselect:function(){return null!==this._emissive&&this.material.emissive&&this.material.emissive.setHex(this._emissive),this.selected=!1,this},toggle:function(){return this.selected?this.deselect():this.select(),this},dispose:function(){this.cell&&this.cell.tile&&(this.cell.tile=null),this.cell=null,this.position=null,this.rotation=null,this.mesh.parent&&this.mesh.parent.remove(this.mesh),this.mesh.userData.structure=null,this.mesh=null,this.material=null,this.userData=null,this.entity=null,this.geometry=null,this._emissive=null}},vg.Tile.prototype.constructor=vg.Tile,vg.TilesetManager=function(e){this.board=e,this.manager=new THREE.LoadingManager(this._loaderComplete.bind(this),this._loaderProgress,this._loaderError),this.imgLoader=new THREE.TextureLoader(this.manager),this.geoLoader=new THREE.BufferGeometryLoader(this.manager),this.tileGeo=null,this.tilesetBasePath=null,this.tilesetMaterials=null,this.tilesetTextures=null,this.onComplete=null,this.onCompleteScope=null},vg.TilesetManager.prototype={load:function(e,t,i){this.onComplete=t,this.onCompleteScope=i,this.tilesetBasePath=e.tilesetBasePath,this.loadMaterials(e.materials),this.geoLoader.load(e.tileGeoPath,function(e){this.tileGeo=e}.bind(this))},loadMaterials:function(e){var t,i;for(this.tilesetTextures=[],i=0;i<e.length;i++)t=e[i],this.tilesetTextures[t.id]={},this._loadTextures(t)},makeTiles:function(){var e,t,i,s=this.board.grid;for(e in s.cells)t=s.cells[e],i=new vg.Tile({cell:t,geometry:this.tileGeo,material:this.tilesetMaterials[t.materialId]}),i.position.copy(s.cellToPixel(t)),i.position.y=t.h*this.board.tileHeightStep,this.board.tiles.push(i),this.board.tileGroup.add(i.mesh)},reset:function(){this.tileGeo=null,this.tilesetMaterials=null,this.tilesetTextures=null},_loaderComplete:function(){var e,t;for(this.tilesetMaterials=[],e=0;e<this.tilesetTextures.length;e++)t=this.tilesetTextures[e],this.tilesetMaterials[e]=new THREE.MeshPhongMaterial({map:t.map,normalMap:t.normalMap||null,emissiveMap:t.emissiveMap||null,specularMap:t.specularMap||null,alphaMap:t.alphaMap||null,shininess:t.shininess||0,specular:t.specular?new THREE.Color(t.specular):null});this.onComplete&&this.onComplete.call(this.onCompleteScope||null)},_loaderProgress:function(e){if(e.lengthComputable){var t=e.loaded/e.total*100;console.log(Math.round(t,2)+"% downloaded")}},_loaderError:function(e){console.warn("[TilesetManager] "+e.statusText)},_loadTextures:function(e){var t=this;this.imgLoader.load(this.tilesetBasePath+e.map,function(i){t.tilesetTextures[e.id].map=i}),e.normalMap&&this.imgLoader.load(this.tilesetBasePath+e.normalMap,function(i){t.tilesetTextures[e.id].normalMap=i}),e.emissiveMap&&this.imgLoader.load(this.tilesetBasePath+e.emissiveMap,function(i){t.tilesetTextures[e.id].emissiveMap=i}),e.specularMap&&this.imgLoader.load(this.tilesetBasePath+e.specularMap,function(i){t.tilesetTextures[e.id].specularMap=i}),e.alphaMap&&this.imgLoader.load(this.tilesetBasePath+e.alphaMap,function(i){t.tilesetTextures[e.id].alphaMap=i})}};
//# sourceMappingURL=von-grid-extras.min.js.map
